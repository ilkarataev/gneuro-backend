name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy (default: develop)'
        required: false
        type: string
        default: 'develop'

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    environment: prod
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'develop' }}
          fetch-depth: 0

      - name: Get deployment info
        id: deploy_info
        run: |
          echo "deploy_ref=${{ github.event.inputs.branch || 'develop' }}" >> $GITHUB_OUTPUT
          echo "deploy_type=manual_branch" >> $GITHUB_OUTPUT

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PROD_SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ vars.PROD_SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to Production Server
        run: |
          echo "ðŸš€ Deploying ${{ steps.deploy_info.outputs.deploy_ref }} to production environment..."
          echo "ðŸ“‹ Deployment type: ${{ steps.deploy_info.outputs.deploy_type }}"

          USER="${{ vars.PROD_SERVER_USER }}"
          REMOTE="${{ vars.PROD_SERVER_HOST }}"
          BASE_NAME="backend-gneuro"
          AREA="production"
          DESTINATION_PATH="/home/${USER}/${AREA}_${BASE_NAME}/"
          DOCKER_COMPOSE_FILE="docker-compose-prod.yaml"

          echo "ðŸ“ Destination: ${USER}@${REMOTE}:${DESTINATION_PATH}"

          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¿Ð°Ð¿ÐºÑƒ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ
          ssh -o StrictHostKeyChecking=no ${USER}@${REMOTE} "mkdir -p ${DESTINATION_PATH}"

          # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ .env
          echo "ðŸ“„ Creating .env file from secrets..."
          cat > .env << 'EOF'
          ${{ secrets.PROD_ENV_FILE }}
          EOF

          # Ð£Ð·Ð½Ð°Ñ‘Ð¼ UID/GID Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼, ÐµÑÐ»Ð¸ Ð¸Ñ… Ð½ÐµÑ‚
          REMOTE_UID=$(ssh -o StrictHostKeyChecking=no ${USER}@${REMOTE} "id -u")
          REMOTE_GID=$(ssh -o StrictHostKeyChecking=no ${USER}@${REMOTE} "id -g")
          grep -q '^APP_UID=' .env || echo "APP_UID=${REMOTE_UID}" >> .env
          grep -q '^APP_GID=' .env || echo "APP_GID=${REMOTE_GID}" >> .env

          # Ð—Ð°Ð»Ð¸Ð²Ð°ÐµÐ¼ .env
          echo "ðŸ“„ Syncing environment file..."
          rsync -avz -e 'ssh -o StrictHostKeyChecking=no ' .env ${USER}@${REMOTE}:${DESTINATION_PATH}/.env
          rm -f .env

          # ÐŸÑ€Ð¾ÐµÐºÑ‚Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
          echo "ðŸ“¦ Syncing project files..."
          rsync -avz -e 'ssh -o StrictHostKeyChecking=no ' docker* src services *.json images ${USER}@${REMOTE}:${DESTINATION_PATH}/

          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð±ÑÐºÐ°Ð¿ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ
          echo "ðŸ’¾ Creating backup..."
          ssh -o StrictHostKeyChecking=no ${USER}@${REMOTE} "cd ${DESTINATION_PATH} && docker compose -f ${DOCKER_COMPOSE_FILE} ps -q > /tmp/backup_containers.txt || true"

          # ÐŸÐ¾Ð´Ð½Ð¸Ð¼Ð°ÐµÐ¼ compose
          echo "ðŸ§© Starting docker-compose..."
          ssh -o StrictHostKeyChecking=no ${USER}@${REMOTE} "cd ${DESTINATION_PATH} && docker compose -f ${DOCKER_COMPOSE_FILE} up -d --build --force-recreate"

          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ ÑÐµÑ€Ð²Ð¸ÑÑ‹ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ð»Ð¸ÑÑŒ
          echo "ðŸ” Checking services health..."
          sleep 30
          ssh -o StrictHostKeyChecking=no ${USER}@${REMOTE} "cd ${DESTINATION_PATH} && docker compose -f ${DOCKER_COMPOSE_FILE} ps"

          echo "âœ… Production deployment completed successfully!"

      - name: Get commit info
        id: commit
        run: |
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "message=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT

      - name: Success notification
        if: success()
        run: |
          echo "## ðŸš€ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Ref:** ${{ steps.deploy_info.outputs.deploy_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Type:** ${{ steps.deploy_info.outputs.deploy_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ steps.commit.outputs.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Author:** ${{ steps.commit.outputs.author }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Message:** ${{ steps.commit.outputs.message }}" >> $GITHUB_STEP_SUMMARY

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Server:** ${{ vars.PROD_SERVER_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- **User:** ${{ vars.PROD_SERVER_USER }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** âœ… Successful" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date)" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "## âŒ Production Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "- **Ref:** ${{ steps.deploy_info.outputs.deploy_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Type:** ${{ steps.deploy_info.outputs.deploy_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ steps.commit.outputs.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Server:** ${{ vars.PROD_SERVER_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** âŒ Failed" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Please check logs and contact the development team**" >> $GITHUB_STEP_SUMMARY
