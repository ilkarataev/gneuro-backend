#!/usr/bin/env node

import dotenv from 'dotenv';
import { BackgroundTaskProcessor } from './services/BackgroundTaskProcessor';

// Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
dotenv.config();

console.log('ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº Ñ„Ð¾Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ñ€Ð° Ð·Ð°Ð´Ð°Ñ‡...');
console.log('ðŸ“… Ð’Ñ€ÐµÐ¼Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ°:', new Date().toISOString());
console.log('ðŸ”§ ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ:');
console.log('  - DATABASE_HOST:', process.env.DATABASE_HOST || 'localhost');
console.log('  - DATABASE_NAME:', process.env.DATABASE_NAME || 'gneuro_api');
console.log('  - BACKGROUND_PROCESSING_INTERVAL:', process.env.BACKGROUND_PROCESSING_INTERVAL || '30000');
console.log('  - MAX_CONCURRENT_BACKGROUND_TASKS:', process.env.MAX_CONCURRENT_BACKGROUND_TASKS || '3');
console.log('  - MAX_BACKGROUND_RETRY_AGE:', process.env.MAX_BACKGROUND_RETRY_AGE || '86400000');

// Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ„Ð¾Ð½Ð¾Ð²Ñ‹Ð¹ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ñ€
BackgroundTaskProcessor.start();

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÑÐ¸Ð³Ð½Ð°Ð»Ð¾Ð² Ð´Ð»Ñ graceful shutdown
process.on('SIGINT', () => {
  console.log('\nðŸ›‘ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½ ÑÐ¸Ð³Ð½Ð°Ð» SIGINT, Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹...');
  process.exit(0);
});

process.on('SIGTERM', () => {
  console.log('\nðŸ›‘ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½ ÑÐ¸Ð³Ð½Ð°Ð» SIGTERM, Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹...');
  process.exit(0);
});

process.on('uncaughtException', (error) => {
  console.error('ðŸ’¥ ÐÐµÐ¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ð¾Ðµ Ð¸ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ:', error);
  process.exit(1);
});

process.on('unhandledRejection', (reason, promise) => {
  console.error('ðŸ’¥ ÐÐµÐ¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ð¾Ðµ Ð¾Ñ‚ÐºÐ»Ð¾Ð½ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾Ð¼Ð¸ÑÐ°:', reason);
  console.error('ðŸ“ ÐŸÑ€Ð¾Ð¼Ð¸Ñ:', promise);
  process.exit(1);
});

console.log('âœ… Ð¤Ð¾Ð½Ð¾Ð²Ñ‹Ð¹ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ñ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð¸ Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ðµ');
console.log('ðŸ“Š Ð”Ð»Ñ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð° ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ API endpoint /admin/background-stats');

// ÐŸÐµÑ€Ð¸Ð¾Ð´Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð²Ñ‹Ð²Ð¾Ð´ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸
setInterval(() => {
  const stats = BackgroundTaskProcessor.getStats();
  console.log('ðŸ“Š [STATS]', {
    isProcessing: stats.isProcessing,
    activeTasks: stats.processingCount,
    maxTasks: stats.maxConcurrentTasks,
    interval: `${stats.processingInterval}ms`
  });
}, 60000); // ÐšÐ°Ð¶Ð´ÑƒÑŽ Ð¼Ð¸Ð½ÑƒÑ‚Ñƒ
