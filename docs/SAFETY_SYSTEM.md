# Система безопасности и согласий

## Обзор

Система безопасности обеспечивает защиту пользователей и соблюдение этических стандартов при обработке изображений с помощью AI.

## Компоненты системы

### 1. Проверка безопасности контента

- **Gemini API фильтрация**: Автоматическая блокировка неподходящего контента
- **Поддержка `IMAGE_SAFETY`**: Для моделей с изображениями
- **Поддержка `SAFETY`**: Для текстовых моделей

### 2. Система согласий пользователей

- **Обязательное согласие**: Перед обработкой изображений
- **Версионирование правил**: Возможность обновления
- **История согласий**: Отслеживание всех согласий

### 3. Правильная обработка ошибок

- **Понятные сообщения**: Для пользователей
- **Правильные статусы**: `completed` для заблокированных запросов
- **Отсутствие списания**: Деньги не списываются за заблокированный контент

## API Эндпоинты

### Получить правила безопасности
```http
GET /api/safety-rules
```

**Ответ:**
```json
{
  "success": true,
  "data": {
    "version": "1.0",
    "lastUpdated": "2025-09-20",
    "rules": [
      "Не загружайте изображения с детьми в неподходящих ситуациях",
      "Не загружайте контент, нарушающий авторские права",
      "Не загружайте изображения с насилием или жестокостью",
      "Не загружайте контент, содержащий ненависть или дискриминацию",
      "Не загружайте изображения сексуального характера",
      "Вы несете ответственность за загружаемый контент",
      "Мы оставляем за собой право блокировать неподходящий контент",
      "При нарушении правил ваш аккаунт может быть заблокирован"
    ]
  }
}
```

### Проверить согласие пользователя
```http
GET /api/safety-agreement/:userId
```

**Ответ:**
```json
{
  "success": true,
  "hasAgreed": false,
  "safetyRules": { ... } // Только если hasAgreed = false
}
```

### Записать согласие пользователя
```http
POST /api/safety-agreement
Content-Type: application/json

{
  "userId": 1,
  "ipAddress": "127.0.0.1",
  "userAgent": "Mozilla/5.0..."
}
```

**Ответ:**
```json
{
  "success": true,
  "message": "Согласие с правилами безопасности записано"
}
```

## Коды ошибок

### SAFETY_AGREEMENT_REQUIRED (403)
Пользователь не согласился с правилами безопасности.

**Ответ:**
```json
{
  "success": false,
  "error": "Необходимо согласие с правилами безопасности",
  "errorCode": "SAFETY_AGREEMENT_REQUIRED",
  "safetyRules": { ... }
}
```

### CONTENT_SAFETY_VIOLATION (400)
Изображение заблокировано по соображениям безопасности.

**Ответ:**
```json
{
  "success": false,
  "error": "К сожалению, это изображение не может быть обработано по соображениям безопасности. Пожалуйста, выберите другое фото.",
  "errorCode": "CONTENT_SAFETY_VIOLATION"
}
```

### COPYRIGHT_VIOLATION (400)
Изображение заблокировано из-за нарушения авторских прав.

**Ответ:**
```json
{
  "success": false,
  "error": "Изображение не может быть обработано из-за нарушения авторских прав. Пожалуйста, используйте другое изображение.",
  "errorCode": "COPYRIGHT_VIOLATION"
}
```

## База данных

### Таблица user_agreements

```sql
CREATE TABLE user_agreements (
  id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT NOT NULL,
  agreement_type VARCHAR(50) NOT NULL,
  version VARCHAR(20) NOT NULL,
  agreed_at DATETIME NOT NULL,
  ip_address VARCHAR(45),
  user_agent TEXT,
  created_at DATETIME NOT NULL,
  updated_at DATETIME NOT NULL,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  UNIQUE KEY idx_user_agreements_user_type (user_id, agreement_type)
);
```

## Логика работы

### 1. Проверка согласия
Перед обработкой любого изображения система проверяет:
- Согласился ли пользователь с правилами безопасности
- Если нет - возвращает ошибку `SAFETY_AGREEMENT_REQUIRED`

### 2. Обработка изображения
- Изображение отправляется в Gemini API
- API анализирует контент на безопасность
- При блокировке возвращается `finishReason: "IMAGE_SAFETY"`

### 3. Обработка результата
- **Успех**: Создается обработанное изображение
- **Блокировка**: Запрос помечается как `completed`, деньги не списываются
- **Ошибка**: Запрос помечается как `failed`

## Интеграция с фронтендом

### 1. Проверка согласия при загрузке
```javascript
// Проверить согласие пользователя
const response = await fetch(`/api/safety-agreement/${userId}`);
const data = await response.json();

if (!data.hasAgreed) {
  // Показать модальное окно с правилами
  showSafetyRulesModal(data.safetyRules);
}
```

### 2. Обработка ошибок безопасности
```javascript
// Обработка ответа от API
if (response.errorCode === 'CONTENT_SAFETY_VIOLATION') {
  showError('Изображение не подходит для обработки. Выберите другое фото.');
} else if (response.errorCode === 'SAFETY_AGREEMENT_REQUIRED') {
  showSafetyRulesModal(response.safetyRules);
}
```

### 3. Запись согласия
```javascript
// Записать согласие пользователя
const agreementResponse = await fetch('/api/safety-agreement', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    userId: userId,
    ipAddress: getClientIP(),
    userAgent: navigator.userAgent
  })
});
```

## Мониторинг и аналитика

### Логи безопасности
- Все блокировки логируются с деталями
- Отслеживание `finishReason` и `safetyRatings`
- Статистика по типам блокировок

### Метрики
- Количество заблокированных запросов
- Популярные причины блокировок
- Эффективность системы согласий

## Обновление правил

### 1. Изменение версии
При обновлении правил безопасности:
- Увеличить версию в `UserAgreementService.SAFETY_RULES_VERSION`
- Обновить правила в `getSafetyRules()`
- Пользователи должны будут согласиться с новыми правилами

### 2. Миграция существующих согласий
```sql
-- Обновить существующие согласия на новую версию
UPDATE user_agreements 
SET version = '2.0', updated_at = NOW() 
WHERE agreement_type = 'safety_rules' AND version = '1.0';
```

## Безопасность

### Защита от обхода
- Согласие проверяется на сервере
- IP адрес и User Agent записываются
- Версионирование предотвращает устаревшие согласия

### Конфиденциальность
- Согласия привязаны к пользователю
- История согласий сохраняется
- Возможность отзыва согласия

## Тестирование

### Автоматические тесты
```bash
# Запуск тестов безопасности
node test_safety_agreement.js

# Тест обработки ошибок
node test_safety_response.js
```

### Ручное тестирование
1. Загрузить неподходящее изображение
2. Проверить правильность сообщения об ошибке
3. Убедиться, что деньги не списались
4. Проверить статус запроса в БД
