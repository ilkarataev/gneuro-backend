# Управление зависшими задачами

## Описание

Система автоматически определяет зависшие задачи на основе времени последнего обновления (`updatedAt`). Задача считается зависшей, если она находится в статусе `processing` более 10 минут.

## Эндпоинты

### 1. Получить список зависших задач

**GET** `/admin/stuck-tasks`

**Параметры:**
- `userId` (query) - ID администратора для авторизации

**Ответ:**
```json
{
  "success": true,
  "data": {
    "stuckTasks": [
      {
        "id": 123,
        "user_id": 456,
        "request_type": "photo_restore",
        "status": "processing",
        "updatedAt": "2025-01-16T10:28:18.000Z",
        "prompt": "Красивый закат над горным озером в акварели",
        "cost": "30.00"
      }
    ],
    "count": 1,
    "threshold": "10 минут"
  }
}
```

### 2. Перезапустить конкретную зависшую задачу

**POST** `/admin/stuck-tasks/:id/restart`

**Параметры:**
- `id` (path) - ID зависшей задачи
- `userId` (body) - ID администратора для авторизации

**Ответ:**
```json
{
  "success": true,
  "message": "Зависшая задача перезапущена успешно",
  "data": {
    "oldTaskId": 123,
    "newTaskId": 124,
    "result": {
      "success": true,
      "restoredUrl": "https://example.com/restored.jpg"
    }
  }
}
```

### 3. Автоматическая очистка зависших задач

**POST** `/admin/stuck-tasks/auto-cleanup`

**Параметры:**
- `userId` (body) - ID администратора для авторизации
- `thresholdMinutes` (body, опционально) - Порог в минутах (по умолчанию 10)

**Ответ:**
```json
{
  "success": true,
  "message": "Автоматически очищено 3 зависших задач",
  "data": {
    "total": 3,
    "cleaned": 3,
    "errors": 0,
    "thresholdMinutes": 10,
    "results": [
      {
        "id": 123,
        "request_type": "photo_restore",
        "updatedAt": "2025-01-16T10:28:18.000Z",
        "status": "cleaned"
      }
    ]
  }
}
```

### 4. Перезапустить все зависшие задачи

**POST** `/admin/stuck-tasks/restart-all`

**Параметры:**
- `userId` (body) - ID администратора для авторизации

**Ответ:**
```json
{
  "success": true,
  "message": "Обработано 3 зависших задач",
  "data": {
    "total": 3,
    "success": 2,
    "errors": 1,
    "results": [
      {
        "id": 123,
        "request_type": "photo_restore",
        "status": "marked_as_failed",
        "message": "Задача помечена как failed"
      }
    ]
  }
}
```

### 5. Обновленная статистика

**GET** `/admin/stats`

Теперь включает поле `stuck` с количеством зависших задач:

```json
{
  "success": true,
  "data": {
    "total": 1000,
    "completed": 800,
    "failed": 150,
    "processing": 45,
    "stuck": 5,
    "byType": [...],
    "byStatus": [...]
  }
}
```

## Логика работы

1. **Обнаружение зависших задач**: Задачи в статусе `processing` с `updatedAt` более 10 минут назад считаются зависшими.

2. **Перезапуск конкретной задачи**:
   - Помечает старую задачу как `failed` с соответствующим сообщением
   - Создает новую задачу с теми же параметрами
   - Выполняет обработку заново

3. **Массовый перезапуск**:
   - Помечает все зависшие задачи как `failed`
   - Не перезапускает их автоматически (требует ручного вмешательства)

## Использование

### Через API
1. Регулярно проверяйте статистику на наличие зависших задач
2. При обнаружении зависших задач используйте соответствующие эндпоинты для их обработки
3. Рекомендуется настроить мониторинг для автоматического уведомления о зависших задачах

### Через админский интерфейс
1. **Статистика**: В админке отображается количество зависших задач в отдельной карточке
2. **Кнопка "Перезапустить"**: Доступна для задач в статусе `processing` и `failed`
3. **Кнопка "Показать зависшие"**: Показывает только зависшие задачи (processing более 10 минут)
4. **Кнопка "Очистить зависшие"**: Автоматически помечает все зависшие задачи как `failed`

### Рекомендации
- Регулярно проверяйте статистику в админке
- При обнаружении зависших задач используйте кнопку "Показать зависшие" для детального просмотра
- Для массовой очистки используйте кнопку "Очистить зависшие"
- Для перезапуска конкретных задач используйте кнопку "Перезапустить" в таблице

## Безопасность

- Все эндпоинты требуют админских прав
- При перезапуске задач не происходит повторного списания средств с баланса пользователя (флаг `adminRetry`)
