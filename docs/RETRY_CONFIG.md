# Конфигурация Retry механизма для Gemini API

## Описание

Добавлен механизм повторных попыток (retry) с экспоненциальным затуханием для случаев, когда Gemini API недоступен. Это поможет справиться с временными сбоями API и повысить надежность сервиса генерации изображений.

## Переменные окружения

Вы можете настроить параметры retry механизма через переменные окружения:

```bash
# Максимальное время ожидания для всех попыток (в миллисекундах)
# По умолчанию: 300000 (5 минут)
GEMINI_MAX_RETRY_DURATION=300000

# Начальная задержка между попытками (в миллисекундах)
# По умолчанию: 1000 (1 секунда)
GEMINI_INITIAL_RETRY_DELAY=1000

# Максимальная задержка между попытками (в миллисекундах)
# По умолчанию: 30000 (30 секунд)
GEMINI_MAX_RETRY_DELAY=30000

# Множитель для экспоненциального роста задержки
# По умолчанию: 2 (каждая следующая задержка в 2 раза больше предыдущей)
GEMINI_BACKOFF_MULTIPLIER=2
```

## Логика работы

1. **Первая попытка**: Выполняется немедленно
2. **Анализ ошибки**: Проверяется, подлежит ли ошибка повторению
3. **Расчет задержки**: Используется экспоненциальный backoff
4. **Повторные попытки**: Продолжаются в течение максимального времени

## Примеры задержек

При стандартных настройках (начальная задержка 1с, множитель 2, максимум 30с):

- Попытка 1: 0 секунд (сразу)
- Попытка 2: 1 секунда
- Попытка 3: 2 секунды
- Попытка 4: 4 секунды
- Попытка 5: 8 секунд
- Попытка 6: 16 секунд
- Попытка 7: 30 секунд (максимум)
- Попытка 8: 30 секунд
- И так далее...

## Типы повторяемых ошибок

Retry выполняется для следующих типов ошибок:
- Таймауты (timeout)
- Сетевые ошибки (network, connection)
- Сервисы недоступны (unavailable, service unavailable)
- Ошибки сервера (internal server error, bad gateway, gateway timeout)
- Лимиты скорости (rate limit, quota exceeded)
- HTTP коды: 500, 502, 503, 504, 429

## Логирование

Система ведет подробные логи всех попыток:
- Время начала каждой попытки
- Продолжительность попытки
- Причина неудачи
- Время задержки перед следующей попыткой
- Общая статистика по завершении

## Пример использования

```typescript
// Механизм автоматически активируется для всех вызовов к Gemini API в следующих сервисах:

// Генерация изображений
const result = await ImageGenerationService.generateImage({
  userId: 123,
  telegramId: 456,
  prompt: "Красивый закат над морем"
});

// Реставрация фотографий
const restorationResult = await PhotoRestorationService.restorePhoto({
  userId: 123,
  telegramId: 456,
  imageUrl: "path/to/image.jpg",
  options: { enhance_face: true }
});

// Стилизация фотографий
const stylizationResult = await PhotoStylizationService.stylizePhoto({
  userId: 123,
  telegramId: 456,
  imageUrl: "path/to/image.jpg",
  styleId: "glamour",
  prompt: "Стиль гламура",
  originalFilename: "photo.jpg"
});

// Стилизация в стиле эпохи
const eraStyleResult = await EraStyleService.stylePhotoByEra({
  userId: 123,
  telegramId: 456,
  imageUrl: "path/to/image.jpg",
  eraId: "russia_19",
  prompt: "Стиль 19 века",
  originalFilename: "photo.jpg"
});

// Retry сработает автоматически при временных сбоях API
```

## Рекомендации

1. **Продакшн**: Используйте стандартные настройки (5 минут максимум)
2. **Разработка**: Можете уменьшить время ожидания для быстрого тестирования
3. **Мониторинг**: Следите за логами retry для анализа качества соединения с API
4. **Алерты**: Настройте алерты при частых retry для раннего обнаружения проблем
