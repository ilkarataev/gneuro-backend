# Исправления таймаутов Telegram Bot API

## Проблема
При создании подготовленных сообщений через Telegram Bot API возникал таймаут 10 секунд:
```
❌ [TelegramBot] Ошибка при создании подготовленного сообщения: AxiosError: timeout of 10000ms exceeded
```

## Реализованные исправления

### 1. Увеличение таймаутов
- **Telegram API**: с 10 до 30 секунд (настраивается через `TELEGRAM_API_TIMEOUT`)
- **Проверка изображений**: с 5 до 10 секунд (настраивается через `IMAGE_CHECK_TIMEOUT`)

### 2. Retry механизм
- **Количество попыток**: 3 (настраивается через `TELEGRAM_MAX_RETRIES`)
- **Экспоненциальная задержка**: 1с → 2с → 4с (максимум 10с)
- **Умная логика**: retry только при таймаутах, не при других ошибках

### 3. Улучшенная обработка ошибок
- **Детальная диагностика**: различные типы ошибок (таймаут, авторизация, сервер недоступен)
- **Правильные HTTP коды**: 504 для таймаутов, 503 для недоступности сервиса
- **Информативные сообщения**: понятные пользователю описания ошибок

### 4. Расширенное логирование
- **Время выполнения**: отслеживание времени каждого запроса
- **Номер попытки**: логирование всех retry попыток
- **Детальная диагностика**: полная информация об ошибках

## Изменённые файлы

### src/services/TelegramBotService.ts
- ✅ Добавлен метод `makeRequestWithRetry()` с экспоненциальной задержкой
- ✅ Увеличены таймауты с настройкой через env переменные
- ✅ Улучшена обработка ошибок с детальной диагностикой
- ✅ Добавлено логирование времени выполнения и попыток

### src/server.ts
- ✅ Улучшена обработка ошибок в endpoint `/api/telegram/prepare-photo-message`
- ✅ Добавлено логирование времени выполнения запросов
- ✅ Правильные HTTP статус-коды для разных типов ошибок

### docs/TELEGRAM_TIMEOUT_CONFIG.md
- ✅ Подробная документация по настройке таймаутов
- ✅ Рекомендации для различных типов серверов
- ✅ Описание логики retry и типов ошибок

### README.MD
- ✅ Добавлена секция с новыми переменными окружения
- ✅ Рекомендации по настройке для разных условий

### test-telegram-timeout.js
- ✅ Скрипт для тестирования исправлений
- ✅ Проверка статуса бота и создания подготовленных сообщений

## Новые переменные окружения

```env
# Настройки таймаутов Telegram Bot API
TELEGRAM_API_TIMEOUT=30000      # 30 секунд (по умолчанию)
IMAGE_CHECK_TIMEOUT=10000       # 10 секунд (по умолчанию)  
TELEGRAM_MAX_RETRIES=3          # 3 попытки (по умолчанию)
```

## Тестирование

Запустите тестовый скрипт для проверки исправлений:
```bash
node test-telegram-timeout.js
```

## Ожидаемый результат

После внедрения исправлений:
- ✅ Таймауты будут происходить реже (30с вместо 10с)
- ✅ При таймауте система автоматически повторит попытку (до 3 раз)
- ✅ Пользователи получат понятные сообщения об ошибках
- ✅ В логах будет детальная информация для отладки
- ✅ Система станет более устойчивой к сетевым проблемам

## Мониторинг

Следите за логами для отслеживания улучшений:
```
✅ [TelegramBot] Запрос успешен с попытки 2
✅ [PREPARE] Подготовленное сообщение создано: BQACAG... (время выполнения: 5240ms)
```
