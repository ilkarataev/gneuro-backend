# Тестирование API согласия с правилами безопасности

## Обзор

Документация по тестированию API endpoints для управления согласием пользователей с правилами безопасности.

## API Endpoints

### 1. Получение правил безопасности

**Endpoint:** `GET /api/safety-rules`

**Описание:** Возвращает текущие правила безопасности для пользователей.

**Заголовки:**
```
Content-Type: application/json
```

**Пример запроса:**
```bash
curl -X GET "http://localhost:3001/api/safety-rules" \
  -H "Content-Type: application/json"
```

**Ожидаемый ответ:**
```json
{
  "success": true,
  "rules": {
    "version": "1.0",
    "content": "Правила безопасности для обработки изображений...",
    "lastUpdated": "2025-09-20T00:00:00.000Z"
  }
}
```

### 2. Проверка согласия пользователя

**Endpoint:** `GET /api/safety-agreement/:userId`

**Описание:** Проверяет, дал ли пользователь согласие с правилами безопасности.

**Параметры:**
- `userId` (number) - ID пользователя

**Пример запроса:**
```bash
curl -X GET "http://localhost:3001/api/safety-agreement/1" \
  -H "Content-Type: application/json"
```

**Ожидаемый ответ (согласие дано):**
```json
{
  "success": true,
  "hasAgreed": true,
  "agreementDate": "2025-09-20T10:30:00.000Z",
  "version": "1.0"
}
```

**Ожидаемый ответ (согласие не дано):**
```json
{
  "success": true,
  "hasAgreed": false,
  "message": "Пользователь не дал согласие с правилами безопасности"
}
```

### 3. Запись согласия пользователя

**Endpoint:** `POST /api/safety-agreement`

**Описание:** Записывает согласие пользователя с правилами безопасности.

**Тело запроса:**
```json
{
  "userId": 1,
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
}
```

**Пример запроса:**
```bash
curl -X POST "http://localhost:3001/api/safety-agreement" \
  -H "Content-Type: application/json" \
  -d '{
    "userId": 1,
    "ipAddress": "192.168.1.1",
    "userAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
  }'
```

**Ожидаемый ответ:**
```json
{
  "success": true,
  "message": "Согласие с правилами безопасности записано",
  "agreementId": 123,
  "agreedAt": "2025-09-20T10:30:00.000Z"
}
```

## Тестовые сценарии

### Сценарий 1: Получение правил безопасности

1. **Цель:** Проверить, что API возвращает актуальные правила безопасности
2. **Шаги:**
   - Отправить GET запрос на `/api/safety-rules`
   - Проверить статус ответа (200)
   - Проверить структуру ответа
   - Проверить наличие обязательных полей: `version`, `content`, `lastUpdated`

### Сценарий 2: Проверка согласия нового пользователя

1. **Цель:** Проверить, что для нового пользователя возвращается `hasAgreed: false`
2. **Шаги:**
   - Использовать несуществующий userId (например, 99999)
   - Отправить GET запрос на `/api/safety-agreement/99999`
   - Проверить, что `hasAgreed: false`

### Сценарий 3: Запись согласия

1. **Цель:** Проверить успешную запись согласия пользователя
2. **Шаги:**
   - Отправить POST запрос на `/api/safety-agreement` с валидными данными
   - Проверить статус ответа (200)
   - Проверить, что возвращается `agreementId` и `agreedAt`

### Сценарий 4: Проверка согласия после записи

1. **Цель:** Проверить, что после записи согласия API возвращает `hasAgreed: true`
2. **Шаги:**
   - Записать согласие для пользователя (сценарий 3)
   - Отправить GET запрос на `/api/safety-agreement/{userId}`
   - Проверить, что `hasAgreed: true`
   - Проверить наличие `agreementDate`

### Сценарий 5: Валидация данных

1. **Цель:** Проверить валидацию входящих данных
2. **Шаги:**
   - Отправить POST запрос без обязательных полей
   - Проверить статус ответа (400)
   - Проверить сообщение об ошибке

## Коды ошибок

| Код | Описание | Причина |
|-----|----------|---------|
| 400 | Bad Request | Неверные данные запроса |
| 404 | Not Found | Пользователь не найден |
| 500 | Internal Server Error | Ошибка сервера |

## Автоматизированное тестирование

### Использование Postman

1. Импортировать коллекцию с тестами
2. Настроить переменные окружения
3. Запустить тестовую коллекцию

### Использование curl

```bash
# Тест получения правил
curl -X GET "http://localhost:3001/api/safety-rules"

# Тест проверки согласия
curl -X GET "http://localhost:3001/api/safety-agreement/1"

# Тест записи согласия
curl -X POST "http://localhost:3001/api/safety-agreement" \
  -H "Content-Type: application/json" \
  -d '{"userId": 1, "ipAddress": "127.0.0.1", "userAgent": "Test"}'
```

## Интеграция с основными сервисами

### Проверка согласия перед обработкой

Все сервисы обработки изображений проверяют согласие пользователя:

- `PhotoRestorationService` - реставрация фото
- `PhotoStylizationService` - стилизация фото  
- `PoetStyleService` - стилизация с поэтом
- `EraStyleService` - стилизация по эпохам
- `ImageGenerationService` - генерация изображений

Если пользователь не дал согласие, возвращается ошибка:
```json
{
  "success": false,
  "error": "Необходимо согласие с правилами безопасности. Пожалуйста, ознакомьтесь с правилами и подтвердите согласие.",
  "errorCode": "SAFETY_AGREEMENT_REQUIRED",
  "safetyRules": {
    "version": "1.0",
    "content": "Правила безопасности..."
  }
}
```

## Мониторинг

### Логи

Все операции с согласием логируются:
- `[USER_AGREEMENT]` - операции с согласием
- `[SAFETY_CHECK]` - проверки безопасности

### Метрики

- Количество пользователей, давших согласие
- Количество отказов от согласия
- Попытки обработки без согласия

## Безопасность

### Защита от злоупотреблений

- Валидация IP адресов
- Ограничение частоты запросов
- Логирование всех операций

### Конфиденциальность

- Минимальное хранение данных
- Анонимизация IP адресов
- Соблюдение GDPR

## Обновление правил

При обновлении правил безопасности:

1. Увеличить версию в `UserAgreementService.getSafetyRules()`
2. Обновить миграцию базы данных
3. Уведомить пользователей о новых правилах
4. Обновить тесты

## Troubleshooting

### Частые проблемы

1. **Ошибка 500 при записи согласия**
   - Проверить подключение к базе данных
   - Проверить валидность userId

2. **Согласие не сохраняется**
   - Проверить права доступа к таблице `user_agreements`
   - Проверить логи миграций

3. **Неправильная версия правил**
   - Проверить метод `getSafetyRules()` в `UserAgreementService`
   - Обновить версию в базе данных
